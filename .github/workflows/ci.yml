name: Lint and validate OpenAPI specs
on:
  - pull_request
jobs:
  lint:
    name: Lint OpenAPI definition
    runs-on: ubuntu-latest
    steps:
      - name: Check out head branch
        uses: actions/checkout@v4
      - name: Run OpenAPI Lint Action
        uses: mhiew/redoc-lint-github-action@v4
        with:
          args: 'openapi/task_execution_service.openapi.yaml'
  validate:
    name: Validate OpenAPI definition
    runs-on: ubuntu-latest
    steps:
      - name: Check out head branch
        uses: actions/checkout@v4
      - name: Run OpenAPI Validate Action
        uses: char0n/swagger-editor-validate@v1
        with:
          definition-file: openapi/task_execution_service.openapi.yaml
  diff:
    name: Show OpenAPI differences relative to target branch
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - name: Check out head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          path: head
      - name: Check out base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: base
      - name: Run OpenAPI Diff
        run: |
          docker run --rm \
          -v $(pwd)/head:/head:ro \
          -v $(pwd)/base:/base:ro \
          -v $(pwd):/local \
          openapitools/openapi-diff:2.0.1 \
          /head/openapi.yaml \
          /base/openapi.yaml \
          --markdown /local/diff.md
      - name: Upload log
        uses: actions/upload-artifact@v4
        with:
          name: openapi-diff-log
          path: diff.md 
  diff-comment:
    name: Create PR comment with OpenAPI diff log (if not empty)
    runs-on: ubuntu-latest
    needs: diff
    if: needs.diff.outputs.log_not_empty == 'false'
    permissions:
      issues: write 
    steps:
      - name: Download OpenAPI diff log
        uses: actions/download-artifact@v4
        with:
          name: openapi-diff-log
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const diff = require('fs').readFileSync('diff.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo, Â  
              body: '## OpenAPI diff:\n\n' + diff
            })
